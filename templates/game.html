{% extends "base.html" %}

{% block title %}Cyber Bomb - Nivel {{ level_number }}{% endblock %}

{% block content %}
<!-- Contenedor para animaci√≥n de explosi√≥n -->
<div id="explosionContainer" class="explosion-container" style="display: none;">
    <canvas id="explosionCanvas"></canvas>
</div>

<!-- HUD del juego -->
<div class="hud">
    <div class="hud-content">
        <div class="hud-item">
            <span class="hud-label">‚è∞ Tiempo:</span>
            <span class="hud-value timer" id="timer">{{ time_left // 60 }}:{{ '%02d' % (time_left % 60) }}</span>
        </div>
        <div class="hud-item">
            <span class="hud-label">üéØ Nivel:</span>
            <span class="hud-value">{{ level_number }}/{{ total_levels }}</span>
        </div>
        <div class="hud-item">
            <span class="hud-label">üí° Pistas:</span>
            <span class="hud-value">{{ hints_left }}</span>
        </div>
        <div class="hud-item">
            <button class="btn" id="hintBtn" onclick="requestHint()" {% if hints_left <= 0 %}disabled{% endif %} aria-label="Pedir pista">
                üí° Pedir Pista
            </button>
        </div>
    </div>
</div>

<div class="main-content">
    <div class="container" id="main-content">
        <div class="text-center">
            <h1>üí£ CYBER BOMB</h1>
            <h2>{{ level.title }}</h2>
            
            <!-- Cron√≥metro individual por pregunta -->
            <div class="question-timer" style="margin: 1rem 0; padding: 1rem; background-color: #1F2937; border-radius: 10px; border: 2px solid #10B981;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
                    <span style="color: #10B981; font-size: 1.1rem; font-weight: bold;">‚è±Ô∏è Tiempo en esta pregunta:</span>
                    <span id="questionTimer" style="color: #FFFFFF; font-size: 1.5rem; font-weight: bold; font-family: monospace;">00:00</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #9CA3AF;">
                    Este cron√≥metro mide cu√°nto tardas en responder esta pregunta espec√≠fica
                </div>
            </div>
            
            <!-- Mensajes de √©xito/error -->
            {% if success_message %}
            <div class="message success" role="alert">
                {{ success_message }}
            </div>
            {% endif %}
            
            {% if error_message %}
            <div class="message error" role="alert">
                {{ error_message }}
            </div>
            {% endif %}
            
            <!-- Caja de pistas -->
            <div id="hintBox" class="message info" style="display: none;" role="alert">
                <strong>üí° Pista:</strong> <span id="hintText"></span>
            </div>
            
            <!-- Contenido del nivel -->
            <div style="margin: 2rem 0; padding: 2rem; background-color: #1F2937; border-radius: 10px; border: 2px solid #374151;">
                <h3>{{ level.prompt }}</h3>
                
                <!-- Formulario din√°mico seg√∫n el tipo de nivel -->
                <form method="POST" action="{{ url_for('game') }}" style="margin-top: 2rem;">
                    <input type="hidden" name="time_left" id="timeInput" value="{{ time_left }}">
                    
                    {% if level.type == "password" %}
                    <!-- Nivel de contrase√±a -->
                    <div class="form-group">
                        <label for="password" aria-label="Ingresa la contrase√±a del administrador">
                            üîì Contrase√±a:
                        </label>
                        <input type="password" 
                               id="password" 
                               name="password" 
                               required 
                               autocomplete="off"
                               placeholder="Ingresa la contrase√±a..."
                               aria-describedby="password-help">
                        <div id="password-help" class="sr-only">
                            Ingresa la contrase√±a del administrador del sistema
                        </div>
                    </div>
                    
                    {% elif level.type == "phishing" %}
                    <!-- Nivel de phishing -->
                    <div class="form-group">
                        <label aria-label="Selecciona el correo leg√≠timo">
                            üìß Selecciona el correo leg√≠timo:
                        </label>
                        <div class="radio-group">
                            {% for option in level.options %}
                            <div class="radio-option">
                                <input type="radio" 
                                       id="option_{{ option.id }}" 
                                       name="phishing_choice" 
                                       value="{{ option.id }}"
                                       required
                                       aria-describedby="option_{{ option.id }}_desc">
                                <label for="option_{{ option.id }}" id="option_{{ option.id }}_desc">
                                    <strong>{{ option.id.upper() }}.</strong> {{ option.label }}
                                    <br><small style="color: #9CA3AF;">Dominio: {{ option.domain }}</small>
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    {% elif level.type == "ransomware" %}
                    <!-- Nivel de ransomware -->
                    <div class="ransomware-container">
                        <!-- Mensaje de rescate -->
                        <div class="ransom-note">
                            <div class="ransom-header">‚ö†Ô∏è SISTEMA COMPROMETIDO ‚ö†Ô∏è</div>
                            <pre class="ransom-text">{{ level.ransom_note }}</pre>
                        </div>
                        
                        <!-- Carpeta de archivos encriptados -->
                        <div class="encrypted-folder">
                            <h4>üìÅ Archivos Encriptados</h4>
                            <div class="file-list">
                                {% for file in level.files %}
                                <div class="encrypted-file" data-clue="{{ file.clue }}">
                                    <span class="file-icon">üîí</span>
                                    <span class="file-name">{{ file.name }}</span>
                                    <span class="file-clue">{{ file.clue }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Mini-puzzles interactivos -->
                        <div class="puzzle-tools">
                            <h4>üß© Herramientas de An√°lisis</h4>
                            <p class="tool-instructions">üí° <strong>Instrucciones:</strong> Usa estas herramientas para descifrar las pistas de los archivos encriptados. ¬°Cada herramienta te dar√° una parte de la clave final!</p>
                            <div class="tool-grid">
                                <div class="tool-card">
                                    <h5>üî§ Base64 Decoder (para c√≥digos como "QkxVRQ==")</h5>
                                    <input type="text" id="base64Input" placeholder="Copia y pega: QkxVRQ==">
                                    <button type="button" onclick="decodeBase64()">Decodificar</button>
                                    <div id="base64Result" class="tool-result"></div>
                                </div>
                                <div class="tool-card">
                                    <h5>üîÄ Anagram Solver (para letras mezcladas como "LEBEL")</h5>
                                    <input type="text" id="anagramInput" placeholder="Escribe: LEBEL">
                                    <button type="button" onclick="solveAnagram()">Resolver Anagrama</button>
                                    <div id="anagramResult" class="tool-result"></div>
                                </div>
                                <div class="tool-card">
                                    <h5>‚ö° XOR Calculator (para operaciones como "32^48")</h5>
                                    <input type="text" id="xorInput" placeholder="32^48">
                                    <button type="button" onclick="calculateXOR()">Calcular XOR</button>
                                    <div id="xorResult" class="tool-result"></div>
                                </div>
                            </div>
                            <div class="final-hint">
                                <p>üéØ <strong>Pista Final:</strong> Combina los resultados en este orden: RESULTADO1 + RESULTADO2 + A√ëO (formado por los n√∫meros 52, 30, 25)</p>
                            </div>
                        </div>
                        
                        <!-- Input para la clave final -->
                        <div class="form-group">
                            <label for="ransomware_key" aria-label="Ingresa la clave de desencriptaci√≥n">
                                üîë Clave de Desencriptaci√≥n:
                            </label>
                            <input type="text" 
                                   id="ransomware_key" 
                                   name="ransomware_key" 
                                   required 
                                   autocomplete="off"
                                   placeholder="Ingresa la clave maestra..."
                                   style="text-transform: uppercase;"
                                   aria-describedby="ransomware-help">
                            <div id="ransomware-help" class="sr-only">
                                Ingresa la clave de desencriptaci√≥n que has descubierto
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary" aria-label="Enviar respuesta">
                            ‚úÖ Enviar Respuesta
                        </button>
                        <a href="{{ url_for('reset') }}" class="btn btn-danger" aria-label="Reiniciar juego">
                            üîÑ Reiniciar
                        </a>
                    </div>
                </form>
            </div>
            
            <!-- Informaci√≥n del nivel -->
            <div style="margin-top: 2rem; padding: 1rem; background-color: #1F2937; border-radius: 5px; border-left: 4px solid #3B82F6;">
                <h4 style="color: #87CEEB; margin-bottom: 0.5rem;">‚ÑπÔ∏è Informaci√≥n del Nivel</h4>
                <p style="font-size: 0.9rem; margin: 0;">
                    <strong>Progreso:</strong> {{ level_number }} de {{ total_levels }} niveles completados<br>
                    <strong>Tiempo restante:</strong> <span id="timeInfo">{{ time_left // 60 }}:{{ '%02d' % (time_left % 60) }}</span><br>
                    <strong>Pistas disponibles:</strong> {{ hints_left }} (cada una resta 10 segundos)
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Estilos para la animaci√≥n de explosi√≥n */
.explosion-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 9999;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    pointer-events: none;
}

#explosionCanvas {
    width: 100%;
    height: 100%;
    max-width: 100vw;
    max-height: 100vh;
}

/* Respeto por prefers-reduced-motion */
@media (prefers-reduced-motion: reduce) {
    .explosion-container {
        animation: none !important;
    }
    
    .explosion-container::before {
        content: 'üí• ¬°TIEMPO AGOTADO! üí•';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2rem;
        color: #EF4444;
        font-weight: bold;
        text-align: center;
        z-index: 10000;
    }
}

/* Estilos para el nivel de ransomware */
.ransomware-container {
    max-width: 100%;
    margin: 0 auto;
}

.ransom-note {
    background: linear-gradient(135deg, #8B0000, #DC143C);
    border: 3px solid #FF0000;
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1rem 0;
    box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
    animation: ransomPulse 2s infinite;
}

.ransom-header {
    font-size: 1.5rem;
    font-weight: bold;
    text-align: center;
    color: #FFFF00;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
    margin-bottom: 1rem;
}

.ransom-text {
    color: #FFFFFF;
    font-family: 'Courier New', monospace;
    font-size: 1rem;
    line-height: 1.4;
    margin: 0;
    white-space: pre-wrap;
}

.encrypted-folder {
    background: #1F2937;
    border: 2px solid #374151;
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.file-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 0.5rem;
    margin-top: 1rem;
}

.encrypted-file {
    background: #2D3748;
    border: 1px solid #4A5568;
    border-radius: 5px;
    padding: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.encrypted-file:hover {
    background: #374151;
    border-color: #6B7280;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}

.file-icon {
    font-size: 1.2rem;
    animation: lockShake 1s infinite;
}

.file-name {
    flex: 1;
    font-family: monospace;
    color: #E5E7EB;
}

.file-clue {
    background: #4B5563;
    color: #F59E0B;
    padding: 0.25rem 0.5rem;
    border-radius: 3px;
    font-family: monospace;
    font-weight: bold;
}

.puzzle-tools {
    background: #1F2937;
    border: 2px solid #10B981;
    border-radius: 10px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.tool-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.tool-card {
    background: #2D3748;
    border: 1px solid #4A5568;
    border-radius: 8px;
    padding: 1rem;
    transition: transform 0.2s ease;
}

.tool-card:hover {
    transform: translateY(-2px);
    border-color: #10B981;
}

.tool-card h5 {
    color: #10B981;
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    line-height: 1.3;
}

.tool-instructions {
    background: linear-gradient(135deg, #4a90e2, #357abd);
    color: white;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #ffd700;
    font-size: 14px;
}

.final-hint {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
    border-left: 4px solid #ffd700;
    text-align: center;
    font-weight: bold;
    animation: pulse-hint 2s infinite;
}

@keyframes pulse-hint {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

.tool-card input {
    width: 100%;
    padding: 0.5rem;
    margin: 0.5rem 0;
    background: #374151;
    border: 1px solid #6B7280;
    border-radius: 4px;
    color: #FFFFFF;
    font-family: monospace;
}

.tool-card button {
    background: #10B981;
    color: #FFFFFF;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.2s ease;
}

.tool-card button:hover {
    background: #059669;
}

.tool-result {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: #374151;
    border-radius: 4px;
    color: #F59E0B;
    font-family: monospace;
    min-height: 1.5rem;
    border: 1px solid #6B7280;
}

/* Animaciones */
@keyframes ransomPulse {
    0%, 100% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.5); }
    50% { box-shadow: 0 0 30px rgba(255, 0, 0, 0.8); }
}

@keyframes lockShake {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-5deg); }
    75% { transform: rotate(5deg); }
}

/* Responsive design */
@media (max-width: 768px) {
    .tool-grid {
        grid-template-columns: 1fr;
    }
    
    .file-list {
        grid-template-columns: 1fr;
    }
    
    .ransom-header {
        font-size: 1.2rem;
    }
}
</style>

<script>
// Variables globales
let timeLeft = parseInt({{ time_left|default(600) }}) || 600;
let timerInterval;
let isGameOver = false;

// Variables para cron√≥metro individual
let questionStartTime = Date.now();
let questionTimerInterval;
let questionTimeElapsed = 0;

// Variables para animaci√≥n de explosi√≥n
let explosionAnimationId;
let particles = [];
let explosionCanvas;
let explosionCtx;

// Clase Particle para la animaci√≥n de explosi√≥n
class Particle {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.vx = (Math.random() - 0.5) * 15;
        this.vy = (Math.random() - 0.5) * 15;
        this.life = 1.0;
        this.decay = Math.random() * 0.02 + 0.01;
        this.size = Math.random() * 8 + 3;
        this.color = this.getRandomColor();
        this.gravity = 0.1;
    }
    
    getRandomColor() {
        const colors = [
            '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
            '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
            '#F8C471', '#82E0AA', '#F1948A', '#85C1E9', '#F4D03F'
        ];
        return colors[Math.floor(Math.random() * colors.length)];
    }
    
    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += this.gravity;
        this.life -= this.decay;
        this.size *= 0.98;
    }
    
    draw(ctx) {
        ctx.save();
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
        
        // Efecto de brillo
        ctx.shadowBlur = 20;
        ctx.shadowColor = this.color;
        ctx.fill();
        
        ctx.restore();
    }
    
    isDead() {
        return this.life <= 0 || this.size <= 0.5;
    }
}

// Funci√≥n para formatear tiempo
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

// Funci√≥n para formatear tiempo del cron√≥metro de pregunta (en segundos con decimales)
function formatQuestionTime(milliseconds) {
    const totalSeconds = Math.floor(milliseconds / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Funci√≥n para iniciar cron√≥metro de pregunta
function startQuestionTimer() {
    questionStartTime = Date.now();
    questionTimeElapsed = 0;
    
    questionTimerInterval = setInterval(function() {
        questionTimeElapsed = Date.now() - questionStartTime;
        const questionTimerElement = document.getElementById('questionTimer');
        if (questionTimerElement) {
            questionTimerElement.textContent = formatQuestionTime(questionTimeElapsed);
        }
    }, 100); // Actualizar cada 100ms para mayor precisi√≥n
}

// Funci√≥n para detener cron√≥metro de pregunta
function stopQuestionTimer() {
    if (questionTimerInterval) {
        clearInterval(questionTimerInterval);
        questionTimerInterval = null;
    }
    return Math.round(questionTimeElapsed / 1000 * 100) / 100; // Retornar tiempo en segundos con 2 decimales
}

// Funci√≥n para actualizar el timer
function updateTimer() {
    const timerElement = document.getElementById('timer');
    const timeInfoElement = document.getElementById('timeInfo');
    const timeInput = document.getElementById('timeInput');
    
    const formattedTime = formatTime(timeLeft);
    timerElement.textContent = formattedTime;
    if (timeInfoElement) timeInfoElement.textContent = formattedTime;
    timeInput.value = timeLeft;
    
    // Cambiar color cuando queden menos de 2 minutos
    if (timeLeft <= 120) {
        timerElement.classList.add('warning');
    } else {
        timerElement.classList.remove('warning');
    }
    
    // Verificar si el tiempo se agot√≥ ANTES de decrementar
    if (timeLeft <= 0) {
        clearInterval(timerInterval);
        isGameOver = true;
        onTimeUp();
        return;
    }
    
    timeLeft--;
}

// Funci√≥n que se ejecuta cuando el tiempo se agota
function onTimeUp() {
    console.log('onTimeUp() ejecutada - iniciando animaci√≥n de explosi√≥n');
    
    // Verificar si las animaciones est√°n deshabilitadas
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        console.log('Animaciones reducidas detectadas - mostrando mensaje simple');
        // Mostrar mensaje simple y redirigir despu√©s de un breve delay
        const container = document.getElementById('explosionContainer');
        if (container) {
            container.style.display = 'flex';
            console.log('Contenedor de explosi√≥n mostrado (modo reducido)');
        } else {
            console.error('No se encontr√≥ el contenedor de explosi√≥n');
        }
        setTimeout(() => {
            window.location.href = '{{ url_for("lose") }}';
        }, 2000);
        return;
    }
    
    console.log('Iniciando animaci√≥n completa de explosi√≥n');
    
    // Inicializar canvas para la animaci√≥n
    if (!initExplosionCanvas()) {
        console.error('Error al inicializar canvas, abortando animaci√≥n');
        setTimeout(() => {
            window.location.href = '{{ url_for("lose") }}';
        }, 1000);
        return;
    }
    
    // Mostrar contenedor de explosi√≥n
    const container = document.getElementById('explosionContainer');
    if (container) {
        container.style.display = 'flex';
        console.log('Contenedor de explosi√≥n mostrado');
    } else {
        console.error('No se encontr√≥ el contenedor de explosi√≥n');
        return;
    }
    
    // Crear m√∫ltiples explosiones
    createExplosion();
    
    // Iniciar animaci√≥n
    animateExplosion();
    
    // Redirigir despu√©s de la animaci√≥n (3 segundos)
    setTimeout(() => {
        console.log('Finalizando animaci√≥n y redirigiendo');
        stopExplosionAnimation();
        window.location.href = '{{ url_for("lose") }}';
    }, 3000);
}

// Inicializar canvas para la explosi√≥n
function initExplosionCanvas() {
    console.log('Inicializando canvas de explosi√≥n');
    explosionCanvas = document.getElementById('explosionCanvas');
    
    if (!explosionCanvas) {
        console.error('No se encontr√≥ el canvas de explosi√≥n');
        return false;
    }
    
    explosionCtx = explosionCanvas.getContext('2d');
    
    if (!explosionCtx) {
        console.error('No se pudo obtener el contexto 2D del canvas');
        return false;
    }
    
    // Ajustar tama√±o del canvas
    explosionCanvas.width = window.innerWidth;
    explosionCanvas.height = window.innerHeight;
    console.log(`Canvas inicializado: ${explosionCanvas.width}x${explosionCanvas.height}`);
    
    // Limpiar part√≠culas anteriores
    particles = [];
    console.log('Canvas de explosi√≥n inicializado correctamente');
    return true;
}

// Crear explosi√≥n con part√≠culas
function createExplosion() {
    const centerX = explosionCanvas.width / 2;
    const centerY = explosionCanvas.height / 2;
    console.log(`Creando explosi√≥n en centro: ${centerX}, ${centerY}`);
    
    // Crear m√∫ltiples ondas de part√≠culas
    for (let wave = 0; wave < 3; wave++) {
        setTimeout(() => {
            console.log(`Creando onda ${wave + 1} de part√≠culas`);
            // Crear part√≠culas en c√≠rculo
            for (let i = 0; i < 80; i++) {
                particles.push(new Particle(centerX, centerY));
            }
            
            // Crear part√≠culas adicionales aleatorias
            for (let i = 0; i < 40; i++) {
                const offsetX = (Math.random() - 0.5) * 100;
                const offsetY = (Math.random() - 0.5) * 100;
                particles.push(new Particle(centerX + offsetX, centerY + offsetY));
            }
            console.log(`Total de part√≠culas despu√©s de onda ${wave + 1}: ${particles.length}`);
        }, wave * 300);
    }
}

// Animar la explosi√≥n
function animateExplosion() {
    if (!explosionCtx || !explosionCanvas) {
        console.error('Canvas o contexto no disponible para animaci√≥n');
        return;
    }
    
    explosionCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
    explosionCtx.fillRect(0, 0, explosionCanvas.width, explosionCanvas.height);
    
    // Actualizar y dibujar part√≠culas
    for (let i = particles.length - 1; i >= 0; i--) {
        const particle = particles[i];
        particle.update();
        particle.draw(explosionCtx);
        
        // Remover part√≠culas muertas
        if (particle.isDead()) {
            particles.splice(i, 1);
        }
    }
    
    // Continuar animaci√≥n si hay part√≠culas
    if (particles.length > 0) {
        explosionAnimationId = requestAnimationFrame(animateExplosion);
    } else {
        console.log('Animaci√≥n de explosi√≥n completada - no quedan part√≠culas');
    }
}

// Detener animaci√≥n de explosi√≥n
function stopExplosionAnimation() {
    if (explosionAnimationId) {
        cancelAnimationFrame(explosionAnimationId);
        explosionAnimationId = null;
    }
    particles = [];
}

// Funci√≥n de prueba para activar la explosi√≥n manualmente (solo para depuraci√≥n)
function testExplosion() {
    console.log('Prueba de explosi√≥n activada manualmente');
    onTimeUp();
}

// Agregar funci√≥n de prueba al objeto window para acceso desde consola
window.testExplosion = testExplosion;

// Funciones para mini-puzzles del nivel de ransomware
function decodeBase64() {
    const input = document.getElementById('base64Input').value.trim();
    const result = document.getElementById('base64Result');
    
    if (!input) {
        result.innerHTML = '<span style="color: #ff6b6b;">‚ö†Ô∏è Copia y pega el c√≥digo: QkxVRQ==</span>';
        return;
    }
    
    try {
        const decoded = atob(input);
        if (decoded === 'BLUE') {
            result.innerHTML = `<span style="color: #4CAF50;">üéâ ¬°Perfecto! Resultado: <strong>${decoded}</strong><br>üí° Esta es la primera parte de la clave</span>`;
        } else {
            result.innerHTML = `<span style="color: #4CAF50;">‚úÖ Resultado: <strong>${decoded}</strong></span>`;
        }
    } catch (error) {
        result.innerHTML = '<span style="color: #ff6b6b;">‚ùå C√≥digo Base64 inv√°lido. Intenta con: QkxVRQ==</span>';
    }
}

function solveAnagram() {
    const input = document.getElementById('anagramInput').value.trim().toUpperCase();
    const result = document.getElementById('anagramResult');
    
    if (!input) {
        result.innerHTML = '<span style="color: #ff6b6b;">‚ö†Ô∏è Escribe las letras: LEBEL</span>';
        return;
    }
    
    // Verificar si las letras forman "BELL"
    const sortedInput = input.split('').sort().join('');
    const targetSorted = 'BELL'.split('').sort().join('');
    
    if (sortedInput === targetSorted) {
        result.innerHTML = '<span style="color: #4CAF50;">üéâ ¬°Excelente! Resultado: <strong>BELL</strong><br>üí° Esta es la segunda parte de la clave</span>';
    } else {
        result.innerHTML = `<span style="color: #F59E0B;">ü§î Letras ordenadas: ${sortedInput}<br>üí° Pista: Piensa en una campana en ingl√©s</span>`;
    }
}

function calculateXOR() {
    const input = document.getElementById('xorInput').value.trim();
    const result = document.getElementById('xorResult');
    
    if (!input) {
        result.textContent = 'Ingresa operaci√≥n XOR (ej: 32^48)';
        return;
    }
    
    try {
        // Parsear la operaci√≥n XOR
        const parts = input.split('^');
        if (parts.length !== 2) {
            throw new Error('Formato inv√°lido');
        }
        
        const num1 = parseInt(parts[0].trim());
        const num2 = parseInt(parts[1].trim());
        
        if (isNaN(num1) || isNaN(num2)) {
            throw new Error('N√∫meros inv√°lidos');
        }
        
        const xorResult = num1 ^ num2;
        result.textContent = `Resultado: ${xorResult}`;
        result.style.color = '#10B981';
    } catch (error) {
        result.textContent = 'Error: Formato inv√°lido (usa: n√∫mero^n√∫mero)';
        result.style.color = '#EF4444';
    }
}

// Funci√≥n para agregar efectos visuales a los archivos encriptados
function initRansomwareEffects() {
    const encryptedFiles = document.querySelectorAll('.encrypted-file');
    
    encryptedFiles.forEach(file => {
        file.addEventListener('click', function() {
            // Efecto de "glitch" al hacer clic
            this.style.animation = 'none';
            this.style.transform = 'scale(1.05)';
            this.style.filter = 'hue-rotate(180deg)';
            
            setTimeout(() => {
                this.style.transform = '';
                this.style.filter = '';
            }, 200);
            
            // Mostrar pista destacada
            const clue = this.querySelector('.file-clue');
            clue.style.animation = 'ransomPulse 1s ease-in-out 3';
        });
    });
}

// Funci√≥n para simular efecto de "desencriptaci√≥n" cuando se ingresa la clave correcta
function simulateDecryption() {
    const files = document.querySelectorAll('.encrypted-file');
    let delay = 0;
    
    files.forEach(file => {
        setTimeout(() => {
            const icon = file.querySelector('.file-icon');
            const name = file.querySelector('.file-name');
            
            // Cambiar icono y nombre
            icon.textContent = '‚úÖ';
            name.textContent = name.textContent.replace('.locked', '');
            name.style.color = '#10B981';
            
            // Efecto visual
            file.style.background = 'linear-gradient(90deg, #2D3748, #10B981, #2D3748)';
            file.style.backgroundSize = '200% 100%';
            file.style.animation = 'shimmer 1s ease-in-out';
        }, delay);
        delay += 200;
    });
}

// Agregar animaci√≥n shimmer para el efecto de desencriptaci√≥n
const shimmerStyle = document.createElement('style');
shimmerStyle.textContent = `
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
`;
document.head.appendChild(shimmerStyle);

// Funci√≥n para solicitar pista
function requestHint() {
    const hintBtn = document.getElementById('hintBtn');
    const hintBox = document.getElementById('hintBox');
    const hintText = document.getElementById('hintText');
    
    // Deshabilitar bot√≥n temporalmente
    hintBtn.disabled = true;
    hintBtn.textContent = '‚è≥ Cargando...';
    
    // Crear formulario para enviar solicitud
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("hint") }}';
    
    const timeInput = document.createElement('input');
    timeInput.type = 'hidden';
    timeInput.name = 'time_left';
    timeInput.value = timeLeft;
    
    form.appendChild(timeInput);
    document.body.appendChild(form);
    
    // Enviar solicitud
    fetch('{{ url_for("hint") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `time_left=${timeLeft}`
    })
    .then(response => response.json())
    .then(data => {
        hintText.textContent = data.hint;
        hintBox.style.display = 'block';
        
        // Actualizar contador de pistas en el HUD
        const hintsElement = document.querySelector('.hud-item:nth-child(3) .hud-value');
        hintsElement.textContent = data.hints_left;
        
        // Deshabilitar bot√≥n si no hay m√°s pistas
        if (data.hints_left <= 0) {
            hintBtn.disabled = true;
            hintBtn.textContent = 'üí° Sin Pistas';
        } else {
            hintBtn.disabled = false;
            hintBtn.textContent = 'üí° Pedir Pista';
        }
        
        // Restar tiempo por usar pista
        timeLeft -= 10;
        updateTimer();
    })
    .catch(error => {
        console.error('Error al solicitar pista:', error);
        hintBtn.disabled = false;
        hintBtn.textContent = 'üí° Pedir Pista';
    })
    .finally(() => {
        document.body.removeChild(form);
    });
}

// Funci√≥n para sincronizar tiempo en env√≠o de formulario
function syncTime() {
    const timeInput = document.getElementById('timeInput');
    timeInput.value = timeLeft;
    
    // Capturar tiempo de respuesta individual
    const questionTime = stopQuestionTimer();
    
    // Agregar campo oculto con el tiempo de respuesta individual
    const form = document.querySelector('form');
    if (form) {
        // Remover campo anterior si existe
        const existingInput = form.querySelector('input[name="question_response_time"]');
        if (existingInput) {
            existingInput.remove();
        }
        
        // Agregar nuevo campo con el tiempo
        const questionTimeInput = document.createElement('input');
        questionTimeInput.type = 'hidden';
        questionTimeInput.name = 'question_response_time';
        questionTimeInput.value = questionTime;
        form.appendChild(questionTimeInput);
    }
}

// Inicializar timer cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Iniciar timer principal
    timerInterval = setInterval(updateTimer, 1000);
    
    // Iniciar cron√≥metro de pregunta
    startQuestionTimer();
    
    // Sincronizar tiempo en env√≠o de formulario
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', syncTime);
    }
    
    // Enfoque en el primer input
    const firstInput = document.querySelector('input[type="text"], input[type="password"]');
    if (firstInput) {
        firstInput.focus();
    }
    
    // Prevenir env√≠o m√∫ltiple
    if (form) {
        form.addEventListener('submit', function() {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Enviando...';
            }
        });
    }
    
    // Inicializar efectos del ransomware si estamos en ese nivel
    if (document.querySelector('.ransomware-container')) {
        initRansomwareEffects();
    }
});

// Limpiar intervalos al salir de la p√°gina
window.addEventListener('beforeunload', function() {
    if (questionTimerInterval) {
        clearInterval(questionTimerInterval);
    }
    if (timerInterval) {
        clearInterval(timerInterval);
    }
    stopExplosionAnimation();
});

// Manejar redimensionamiento para mantener la animaci√≥n responsive
window.addEventListener('resize', function() {
    if (explosionCanvas && explosionCtx) {
        explosionCanvas.width = window.innerWidth;
        explosionCanvas.height = window.innerHeight;
    }
});

// Prevenir p√©rdida de datos al cerrar/recargar
window.addEventListener('beforeunload', function(e) {
    if (!isGameOver) {
        e.preventDefault();
        e.returnValue = '¬øEst√°s seguro de que quieres salir? Perder√°s el progreso del juego.';
    }
});

// Navegaci√≥n por teclado
document.addEventListener('keydown', function(e) {
    // Enter para enviar formulario
    if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
        const form = document.querySelector('form');
        if (form) {
            e.preventDefault();
            form.submit();
        }
    }
    
    // H para solicitar pista
    if (e.key.toLowerCase() === 'h' && !e.target.matches('input, textarea')) {
        const hintBtn = document.getElementById('hintBtn');
        if (hintBtn && !hintBtn.disabled) {
            e.preventDefault();
            requestHint();
        }
    }
});
</script>
{% endblock %}
